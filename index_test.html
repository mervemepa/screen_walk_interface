<!--
Desktop Documentary (c) 2025 Merve Mepa
Licensed under CC BY-NC-ND 4.0 International
Unauthorized use, modification, or redistribution is prohibited.
https://creativecommons.org/licenses/by-nc-nd/4.0/
-->
<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Desktop Documentary</title>
    <style>
        :root {
            --teal: #008080;
            --deep: #004444;
            --bar: #c0c0c0;
            --bar2: #a0a0a0;
            --title1: #000080;
            --title2: #0000ff;
            --text: #111;
            --shadow: rgba(0, 0, 0, .4);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'MS Sans Serif', sans-serif;
            overflow: hidden;
            background: var(--teal)
        }

        .desktop {
            position: relative;
            width: 100vw;
            height: 100vh;
            background:
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, .1) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, .1) 1px, transparent 1px),
                linear-gradient(45deg, var(--teal) 0%, #006666 50%, var(--deep) 100%);
            background-size: 50px 50px, 50px 50px, 100% 100%;
        }

        .desktop-icons {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 64px;
            color: #fff;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, .8);
            cursor: default;
            padding: 4px;
            border-radius: 4px
        }

        .desktop-icon-image {
            width: 32px;
            height: 32px;
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #000;
            font-family: 'MS Sans Serif', sans-serif;
            text-align: center;
            line-height: 1;
        }

        /* Classic Windows icon styling */
        .desktop-icon-image.folder {
            color: #ffd700;
            background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%);
        }
        
        .desktop-icon-image.recycle {
            color: #666;
            background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%);
        }
        
        .desktop-icon-image.computer {
            color: #4169e1;
            background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%);
        }
        
        .desktop-icon-image.network {
            color: #228b22;
            background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%);
        }
        
        .desktop-icon-image.settings {
            color: #dc143c;
            background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%);
        }

        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, var(--bar) 0%, var(--bar2) 100%);
            border-top: 1px solid #dfdfdf;
            display: flex;
            align-items: center;
            padding: 0 4px;
            z-index: 1001
        }

        .start-button {
            background: linear-gradient(to bottom, var(--bar) 0%, var(--bar2) 100%);
            border: 1px outset var(--bar);
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 4px
        }

        .taskbar-time {
            margin-left: auto;
            background: linear-gradient(to bottom, #dfdfdf 0%, var(--bar) 100%);
            border: 1px inset var(--bar);
            padding: 2px 8px;
            font-size: 11px
        }

        .window {
            position: absolute;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            opacity: 0;
            transform: scale(.1);
            transition: all .6s cubic-bezier(.34, 1.56, .64, 1);
            min-width: 220px;
            max-width: 520px;
            box-shadow: 4px 4px 8px var(--shadow);
            z-index: 100
        }

        .window.open {
            opacity: 1;
            transform: scale(1)
        }

        .window-titlebar {
            background: linear-gradient(to right, var(--title1) 0%, var(--title2) 100%);
            height: 18px;
            display: flex;
            align-items: center;
            padding: 2px 4px;
            color: #fff;
            font-size: 11px;
            font-weight: bold;
            cursor: move
        }

        .window-controls {
            margin-left: auto;
            display: flex;
            gap: 2px
        }

        .window-control {
            width: 16px;
            height: 14px;
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold
        }

        .window-control:active {
            border: 1px inset #c0c0c0
        }

        .window-title {
            margin-right: auto;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 240px
        }

        .window-content {
            padding: 8px;
            background: #c0c0c0;
            border-top: 1px solid #808080
        }

        .window-content img,
        .window-content video {
            display: block;
            max-width: 100%;
            max-height: 420px;
            border: 1px inset #c0c0c0;
            padding: 2px;
            background: #e6e6e6
        }

        /* Audio player styles */
        .audio-player {
            text-align: center;
            padding: 20px;
            background: #e6e6e6;
            border: 1px inset #c0c0c0;
        }

        .audio-player audio {
            width: 100%;
            margin-bottom: 15px;
        }

        .audio-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .audio-icon {
            font-size: 48px;
            opacity: 0.8;
        }

        .audio-title {
            font-weight: bold;
            font-size: 12px;
            color: #000080;
            word-wrap: break-word;
            max-width: 100%;
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 10px;
            z-index: 1002;
            width: 240px;
            min-width: 200px;
            max-width: 600px;
            resize: horizontal;
            overflow: auto;
        }

        .controls h3 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #000080
        }

        .btn {
            background: linear-gradient(to bottom, var(--bar) 0%, var(--bar2) 100%);
            border: 1px outset var(--bar);
            padding: 4px 8px;
            font-size: 11px;
            margin: 3px 0;
            display: inline-block
        }

        .btn:active {
            border: 1px inset var(--bar)
        }

        .btn.block {
            display: block;
            width: 100%
        }

        .btn.rec {
            background: linear-gradient(to bottom, #ff6b6b 0%, #ff5252 100%);
            color: #fff
        }

        .status {
            font-size: 10px;
            color: #333;
            margin-top: 4px;
            text-align: left;
            min-height: 16px
        }

        .row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin: 4px 0
        }

        .row label {
            font-size: 11px;
            min-width: 80px
        }

        input[type="range"] {
            width: 100%
        }

        /* Resizable playlist */
        ul#playlist {
            margin: 6px 0 0 0;
            padding: 0;
            list-style: none;
            height: 120px;
            /* Default height */
            min-height: 60px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px inset #bbb;
            background: #eee;
            resize: vertical;
            position: relative;
        }

        /* Custom resize handle for playlist */
        #playlist::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, transparent 0%, transparent 40%, #999 40%, #999 50%, transparent 50%, transparent 90%, #999 90%);
            cursor: nw-resize;
            pointer-events: none;
        }

        /* Media item styling with better layout */
        #playlist li {
            padding: 4px 6px;
            border-bottom: 1px solid #ddd;
            font-size: 11px;
            font-family: 'MS Sans Serif', sans-serif;
            display: flex;
            gap: 6px;
            align-items: center;
            cursor: grab;
            min-height: 26px;
        }

        #playlist li:hover {
            background: #f5f5f5;
        }

        #playlist li:last-child {
            border-bottom: none;
        }

        #playlist .handle {
            font-weight: bold;
            color: #666;
            cursor: grab;
            user-select: none;
        }

        #playlist .name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        #playlist .type {
            background: #007acc;
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 9px;
            text-transform: uppercase;
            min-width: 40px;
            text-align: center;
        }

        #playlist .type.video {
            background: #ff6b35;
        }

        #playlist .duration {
            color: #666;
            font-size: 10px;
            min-width: 30px;
            text-align: right;
        }

        /* Individual delete button for playlist items */
        #playlist .delete-btn {
            background: transparent;
            border: none;
            color: #666;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            font-family: 'MS Sans Serif', sans-serif;
        }

        #playlist .delete-btn:hover {
            color: #333;
            background: #e0e0e0;
            border-radius: 2px;
        }

        #playlist .delete-btn:active {
            background: #d0d0d0;
        }

        /* Draggable resize handle for the entire panel */
        .controls::before {
            content: "";
            position: absolute;
            left: -5px;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: ew-resize;
            background: transparent;
            z-index: 10;
        }

        .controls.resizing {
            user-select: none;
            pointer-events: none;
        }

        .controls.resizing * {
            pointer-events: none;
        }

        /* Status bar with scroll info */
        .playlist-info {
            font-size: 9px;
            color: #666;
            text-align: right;
            margin-top: 2px;
            height: 12px;
        }

        /* Responsive text based on panel width */
        @media (max-width: 300px) {
            .controls {
                font-size: 10px;
            }

            #playlist .type {
                display: none;
            }

            #playlist .duration {
                font-size: 9px;
            }
        }

        .hint {
            font-size: 10px;
            color: #444;
            margin-top: 6px;
            font-family: 'MS Sans Serif', sans-serif;
        }

        /* Text Performance Window */
        .text-window {
            position: absolute;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            min-width: 300px;
            max-width: 600px;
            width: 400px;
            height: 250px;
            box-shadow: 4px 4px 8px var(--shadow);
            z-index: 200;
            resize: both;
            overflow: hidden;
        }

        .text-window .window-titlebar {
            background: linear-gradient(to right, var(--title1) 0%, var(--title2) 100%);
            height: 18px;
            display: flex;
            align-items: center;
            padding: 2px 4px;
            color: #fff;
            font-size: 11px;
            font-weight: bold;
            cursor: move;
        }

        .text-window .text-content {
            padding: 8px;
            background: #fff;
            border: 1px inset #c0c0c0;
            margin: 4px;
            height: calc(100% - 34px);
            overflow: hidden;
        }

        .text-window textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            background: #fff;
            color: #000;
            resize: none;
            padding: 4px;
            line-height: 1.5;
        }

        /* Text button in controls */
        .btn.text-btn {
            background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
            border: 1px outset #e0e0e0;
        }

        .btn.text-btn:active {
            border: 1px inset #e0e0e0;
        }

        .btn.text-btn.active {
            background: linear-gradient(to bottom, #b0c4de 0%, #87ceeb 100%);
            border: 1px inset #87ceeb;
        }

        /* Audio Section Styles */
        .audio-section {
            margin: 10px 0;
            padding: 8px;
            border: 1px inset #c0c0c0;
            background: #e6e6e6;
        }

        .audio-section h4 {
            margin: 0 0 8px 0;
            font-size: 11px;
            color: #000080;
        }

        .btn.audio-btn {
            background: linear-gradient(to bottom, #dda0dd 0%, #ba55d3 100%);
            border: 1px outset #dda0dd;
        }

        .btn.audio-btn:hover {
            background: linear-gradient(to bottom, #e6b3e6 0%, #c967c9 100%);
        }

        .audio-controls {
            margin-top: 8px;
        }

        .audio-controls audio {
            width: 100%;
            height: 32px;
            margin-bottom: 5px;
        }

        .audio-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
        }

        .btn.small {
            padding: 2px 6px;
            font-size: 10px;
            min-width: auto;
        }
    </style>
</head>

<body>
    <div class="desktop" id="desktop">
        <div class="desktop-icons">
            <div class="desktop-icon">
                <div class="desktop-icon-image">ÔøΩÔ∏è</div><span>My Documents</span>
            </div>
            <div class="desktop-icon">
                <div class="desktop-icon-image">ÔøΩ</div><span>Recycle Bin</span>
            </div>
            <div class="desktop-icon">
                <div class="desktop-icon-image">ÔøΩ</div><span>My Computer</span>
            </div>
            <div class="desktop-icon">
                <div class="desktop-icon-image">üåê</div><span>Network Neighborhood</span>
            </div>
            <div class="desktop-icon">
                <div class="desktop-icon-image">‚öô</div><span>Control Panel</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <h3>Desktop Documentary</h3>
        <div class="row">
            <button class="btn" id="addBtn">üì• Upload Media</button>
            <button class="btn" id="demoBtn" title="Loads 5 sample images">‚ú® Demo</button>
            <button class="btn text-btn" id="textBtn" title="Open text box for performance">üìù Text</button>
            <input type="file" id="filePicker" accept="image/*,video/*" multiple hidden />
        </div>

        <!-- Audio Section -->
        <div class="audio-section">
            <h4>üéµ Background Audio</h4>
            <button class="btn audio-btn" id="audioBtn">üéµ Upload Audio</button>
            <input type="file" id="audioPicker" accept="audio/*" multiple hidden />
            <div id="audioPlayer" class="audio-controls" style="display:none;">
                <audio id="backgroundAudio" controls loop>
                    Your browser does not support audio.
                </audio>
                <div class="audio-info">
                    <span id="audioTitle">No audio selected</span>
                    <button id="clearAudio" class="btn small">√ó</button>
                </div>
            </div>
        </div>

        <div class="row">
            <label for="speed">Duration (s):</label>
            <input id="speed" type="range" min="1" max="8" step="0.5" value="3" />
            <span id="speedVal" style="font-size:11px">3.0</span>
        </div>

        <div class="row">
            <label for="maxWin">Max Windows:</label>
            <input id="maxWin" type="range" min="3" max="20" step="1" value="8" />
            <span id="maxWinVal" style="font-size:11px">8</span>
        </div>

        <div class="row">
            <label for="seed">Random Seed:</label>
            <input id="seed" type="number" value="" placeholder="optional" style="width:100%" />
        </div>

        <button class="btn block" id="startBtn">‚ñ∂ Start</button>
        <button class="btn block" id="resetBtn">üîÑ Reset</button>
        <button class="btn block rec" id="recBtn">‚è∫ Record</button>

        <div class="status" id="status">Add files or press Demo.</div>

        <ul id="playlist"></ul>
        <div class="playlist-info"></div>
        <div class="hint">Drag & Resize</div>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
        <div class="start-button">Start</div>
        <div class="taskbar-time" id="clock">12:00</div>
    </div>

    <script>
        /* ---------- State ---------- */
        let mediaItems = [];       // {name, type:'image'|'video', url, duration} - visual media only
        let audioItems = [];       // {name, url} - background audio files
        let currentAudio = null;   // currently loaded audio
        let isRunning = false;
        let currentIndex = 0;
        let openWindows = [];
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let rnd = Math.random;     // seed'lenebilir
        let draggedIndex = null;   // for drag and drop functionality

        /* ---------- System Sounds ---------- */
        const systemSounds = {
            open: () => playTone(800, 100),
            close: () => playTone(400, 150),
            start: () => playTone([600, 800, 1000], 200),
            error: () => playTone(200, 300)
        };

        function playTone(frequencies, duration = 100) {
            if (!frequencies) return;
            const freqArray = Array.isArray(frequencies) ? frequencies : [frequencies];
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const gainNode = audioContext.createGain();
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            
            freqArray.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                oscillator.connect(gainNode);
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                oscillator.start(audioContext.currentTime + index * 0.05);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            });
        }

        /* ---------- Helpers ---------- */
        function seededRandom(seed) {
            // Mulberry32
            let t = seed >>> 0;
            return function () {
                t += 0x6D2B79F5;
                let r = Math.imul(t ^ t >>> 15, 1 | t);
                r ^= r + Math.imul(r ^ r >>> 7, 61 | r);
                return ((r ^ r >>> 14) >>> 0) / 4294967296;
            }
        }

        function updateClock() {
            const now = new Date();
            const t = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').textContent = t;
        }
        setInterval(updateClock, 1000); updateClock();

        function px(n) { return `${n}px`; }

        // Add file validation for visual media
        function validateFile(file) {
            const maxSize = 100 * 1024 * 1024; // 100MB
            const allowedTypes = ['image/', 'video/'];
            return file.size <= maxSize &&
                allowedTypes.some(type => file.type.startsWith(type));
        }

        // Add file validation for audio
        function validateAudioFile(file) {
            const maxSize = 50 * 1024 * 1024; // 50MB for audio
            return file.size <= maxSize && file.type.startsWith('audio/');
        }

        /* ---------- Chaotic random layout ---------- */
        function generateChaoticPosition(index, total) {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight - 60; // taskbar
            
            // Create clusters and scattered elements for organic feel
            const useCluster = rnd() < 0.4; // 40% chance for clustering
            
            if (useCluster && total > 3) {
                // Create loose clusters around random points
                const clusterCenterX = rnd() * (screenWidth * 0.6) + screenWidth * 0.2;
                const clusterCenterY = rnd() * (screenHeight * 0.6) + screenHeight * 0.2;
                const scatterRange = 150 + rnd() * 200; // Random scatter range
                
                const x = Math.max(20, Math.min(
                    clusterCenterX + (rnd() - 0.5) * scatterRange,
                    screenWidth - 420
                ));
                const y = Math.max(20, Math.min(
                    clusterCenterY + (rnd() - 0.5) * scatterRange,
                    screenHeight - 320
                ));
                
                return { x, y };
            } else {
                // Completely scattered positioning
                const padding = 20;
                const maxX = screenWidth - 420; // leave room for window width
                const maxY = screenHeight - 320; // leave room for window height
                
                // Use different random distributions for more organic feel
                let x, y;
                if (rnd() < 0.3) {
                    // Sometimes prefer edges (30% chance)
                    x = rnd() < 0.5 ? 
                        padding + rnd() * 200 : // Left side
                        maxX - 200 + rnd() * 200; // Right side
                    y = padding + (rnd() * (maxY - padding));
                } else {
                    // Normal random distribution
                    x = padding + (rnd() * (maxX - padding));
                    y = padding + (rnd() * (maxY - padding));
                }
                
                return { x, y };
            }
        }

        function getChaoticSize() {
            // More varied size distribution with larger sizes
            const sizeVariations = [
                { min: 280, max: 420, weight: 0.3 }, // Small
                { min: 380, max: 580, weight: 0.4 }, // Medium
                { min: 520, max: 720, weight: 0.2 }, // Large
                { min: 240, max: 320, weight: 0.1 }  // Compact (for variety)
            ];
            
            // Select size category based on weights
            const rand = rnd();
            let cumulative = 0;
            let selectedRange = sizeVariations[1]; // default to medium
            
            for (const variation of sizeVariations) {
                cumulative += variation.weight;
                if (rand <= cumulative) {
                    selectedRange = variation;
                    break;
                }
            }
            
            const width = selectedRange.min + (rnd() * (selectedRange.max - selectedRange.min));
            
            // Height should somewhat correlate with width but with variation
            const aspectRatio = 0.6 + rnd() * 0.6; // Random aspect ratio between 0.6 and 1.2
            const height = Math.max(180, width * aspectRatio); // Increased minimum height
            
            return { 
                width: Math.floor(width), 
                height: Math.floor(height),
                className: '' // no size class needed
            };
        }

        /* ---------- Window creation + drag ---------- */
        function makeDraggable(win, handle) {
            let ox = 0, oy = 0, dragging = false;
            handle.addEventListener('mousedown', e => {
                dragging = true; ox = e.clientX - win.offsetLeft; oy = e.clientY - win.offsetTop;
                document.body.style.userSelect = 'none';
            });
            window.addEventListener('mousemove', e => {
                if (!dragging) return;
                win.style.left = px(e.clientX - ox);
                win.style.top = px(e.clientY - oy);
            });
            window.addEventListener('mouseup', () => {
                dragging = false; document.body.style.userSelect = '';
            });
        }

        function createWindow(item, index) {
            const desktop = document.getElementById('desktop');
            const win = document.createElement('div');
            const size = getChaoticSize();
            win.className = `window ${size.className}`;
            win.id = `window-${index}-${Date.now()}`; // Make unique for loops

            const pos = generateChaoticPosition(index % mediaItems.length, mediaItems.length); // Use modulo for position
            win.style.left = px(pos.x); 
            win.style.top = px(pos.y);
            win.style.width = px(size.width);
            win.style.height = px(size.height);
            win.style.zIndex = 100 + Math.floor(rnd() * 50); // Random z-index for more chaos

            const content = item.type === 'image'
                ? `<img src="${item.url}" alt="${item.name}" />`
                : `<video controls autoplay muted playsinline>
             <source src="${item.url}" type="video/mp4">
           </video>`;

            win.innerHTML = `
        <div class="window-titlebar">
            <div class="window-title" title="${item.name}">${item.name}</div>
            <div class="window-controls">
                <div class="window-control" data-act="min">_</div>
                <div class="window-control" data-act="max">‚ñ°</div>
                <div class="window-control" data-act="close">√ó</div>
            </div>
        </div>
        <div class="window-content">${content}</div>
    `;

            desktop.appendChild(win);
            openWindows.push(win);

            const titlebar = win.querySelector('.window-titlebar');
            makeDraggable(win, titlebar);

            // Window controls
            win.querySelector('.window-controls').addEventListener('click', (e) => {
                const act = e.target.getAttribute('data-act');
                if (act === 'close') closeWindow(win.id);
                if (act === 'min') win.style.opacity = .2;
                if (act === 'max') win.style.opacity = 1;
            });

            // Appear animation
            setTimeout(() => { 
        win.classList.add('open'); 
        win.style.transform = 'scale(1)';
        systemSounds.open(); // Play open sound
    }, 50);

            // Cap max open windows
            const maxOpen = parseInt(document.getElementById('maxWin').value, 10);
            if (openWindows.length > maxOpen) {
                const toClose = openWindows.shift();
                if (toClose) closeWindow(toClose.id, true);
            }

            // Update loop status
            updateLoopStatus();
            
            return win;
        }

        function closeWindow(id, instant = false) {
            const w = document.getElementById(id);
            if (!w) return;
            if (instant) {
                w.remove();
            } else {
                w.style.transform = 'scale(.1)'; w.style.opacity = '0';
                setTimeout(() => w.remove(), 300);
            }
            openWindows = openWindows.filter(x => x.id !== id);
        }

        /* ---------- Playlist UI ---------- */
        const playlistEl = document.getElementById('playlist');
        function renderPlaylist() {
            if (!mediaItems.length) {
                playlistEl.innerHTML = '<li style="color:#666;font-style:italic;">No media added yet</li>';
                updatePlaylistInfo();
                return;
            }

            playlistEl.innerHTML = mediaItems.map((item, i) => `
            <li draggable="true" data-index="${i}">
                <span class="handle">‚ãÆ‚ãÆ</span>
                <span class="name" title="${item.name}">${item.name}</span>
                <span class="type ${item.type}">${item.type === 'image' ? 'img' : 'vid'}</span>
                <span class="duration">${(item.duration/1000).toFixed(1)}s</span>
                <button class="delete-btn" onclick="deleteItem(${i})" title="Delete this item">üóë</button>
            </li>
        `).join('');

            // Re-attach drag and drop listeners
            attachPlaylistDragListeners();
            updatePlaylistInfo();
        }

        /* ---------- Delete Individual Item ---------- */
        function deleteItem(index) {
            if (index < 0 || index >= mediaItems.length) return;
            
            const item = mediaItems[index];
            
            // Show confirmation dialog in Windows 95 style
            if (!confirm(`Are you sure you want to remove "${item.name}" from the list?`)) {
                return;
            }
            
            // Clean up blob URL if it exists
            if (item.url && item.url.startsWith('blob:')) {
                URL.revokeObjectURL(item.url);
            }
            
            // Remove from array
            mediaItems.splice(index, 1);
            
            // Update storage and UI
            saveLocal();
            renderPlaylist();
            
            // Update status
            document.getElementById('status').textContent = `"${item.name}" silindi.`;
            
            // Clear status after 3 seconds
            setTimeout(() => {
                const currentStatus = document.getElementById('status').textContent;
                if (currentStatus === `"${item.name}" silindi.`) {
                    document.getElementById('status').textContent = mediaItems.length > 0 
                        ? `${mediaItems.length} √∂ƒüe hazƒ±r.` 
                        : 'Dosya ekle veya Demo\'ya bas.';
                }
            }, 3000);
        }

        function attachPlaylistDragListeners() {
            const items = playlistEl.querySelectorAll('li[draggable]');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                
                // Prevent drag when clicking delete button
                const deleteBtn = item.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                    });
                }
            });
            
            // Also add listeners to the playlist container for dropping between items
            playlistEl.addEventListener('dragover', handlePlaylistDragOver);
            playlistEl.addEventListener('drop', handlePlaylistDrop);
        }

        /* ---------- Enhanced Drag Handlers (prevent delete during drag) ---------- */
        function handleDragStart(e) {
            // Prevent dragging if clicking on delete button
            if (e.target.classList.contains('delete-btn')) {
                e.preventDefault();
                return false;
            }
            
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.style.opacity = '0.5';
            
            // Disable delete buttons during drag
            e.currentTarget.querySelectorAll('.delete-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
            });
        }

        function handleDragEnd(e) {
            e.currentTarget.style.opacity = '';
            e.currentTarget.style.borderTop = '';
            e.currentTarget.style.backgroundColor = '';
            draggedIndex = null;

            // Re-enable delete buttons after drag
            playlistEl.querySelectorAll('.delete-btn').forEach(btn => {
                btn.style.pointerEvents = 'auto';
            });

            // Clear all visual effects from all playlist items
            playlistEl.querySelectorAll('li').forEach(li => {
                li.style.borderTop = '';
                li.style.backgroundColor = '';
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Add visual feedback for drop target
            const dragOverIndex = parseInt(e.currentTarget.dataset.index);
            if (draggedIndex !== null && draggedIndex !== dragOverIndex) {
                e.currentTarget.style.borderTop = '2px solid #0078d4';
            }
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (draggedIndex !== null) {
                e.currentTarget.style.backgroundColor = 'rgba(0, 120, 212, 0.1)';
            }
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '';
            e.currentTarget.style.borderTop = '';
        }

        function handlePlaylistDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handlePlaylistDrop(e) {
            e.preventDefault();
            
            if (draggedIndex === null) return;
            
            // If dropped on the playlist but not on a specific item, move to end
            if (!e.target.closest('li[draggable]')) {
                const draggedItem = mediaItems[draggedIndex];
                mediaItems.splice(draggedIndex, 1);
                mediaItems.push(draggedItem);
                
                // Update the playlist display
                renderPlaylist();
                
                // Save to local storage
                saveLocal();
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedIndex === null) return;
            
            const dropIndex = parseInt(e.currentTarget.dataset.index);
            
            if (draggedIndex === dropIndex) return;
            
            // Reorder the mediaItems array
            const draggedItem = mediaItems[draggedIndex];
            mediaItems.splice(draggedIndex, 1);
            
            // Adjust drop index if we removed an item before it
            const newDropIndex = draggedIndex < dropIndex ? dropIndex - 1 : dropIndex;
            mediaItems.splice(newDropIndex, 0, draggedItem);
            
            // Update the playlist display
            renderPlaylist();
            
            // Save to local storage
            saveLocal();
        }

        /* ---------- Local persistence ---------- */
        function saveLocal() { localStorage.setItem('dd_media', JSON.stringify(mediaItems.map(m => ({ name: m.name, type: m.type, url: m.url, duration: m.duration })))) }
        function loadLocal() {
            try {
                const raw = localStorage.getItem('dd_media');
                if (!raw) return;
                const arr = JSON.parse(raw);
                // Blob URL'leri yeni oturumda ge√ßersizdir, bu y√ºzden sadece name/type tutmak mantƒ±klƒ±.
                // Burada bilin√ßli olarak temiz bƒ±rakƒ±yoruz.
            } catch (_) { }
        }

        /* ---------- Audio Management ---------- */
        async function addAudioFiles(fileList) {
            const items = Array.from(fileList);
            let addedCount = 0;
            
            for (const f of items) {
                if (!validateAudioFile(f)) {
                    systemSounds.error();
                    const msg = `Invalid audio file: ${f.name} (type: ${f.type}, size: ${(f.size / (1024 * 1024)).toFixed(1)}MB)`;
                    document.getElementById('status').textContent = msg;
                    setTimeout(() => { if (document.getElementById('status').textContent === msg) document.getElementById('status').textContent = ''; }, 5000);
                    continue;
                }
                
                const url = URL.createObjectURL(f);
                audioItems.push({ name: f.name, url });
                addedCount++;
            }
            
            if (addedCount > 0) {
                systemSounds.open();
                loadAudioPlaylist();
            }
        }

        function loadAudioPlaylist() {
            if (audioItems.length === 0) return;
            
            const audioPlayer = document.getElementById('audioPlayer');
            const backgroundAudio = document.getElementById('backgroundAudio');
            const audioTitle = document.getElementById('audioTitle');
            
            // Load first audio file
            if (!currentAudio) {
                currentAudio = audioItems[0];
                backgroundAudio.src = currentAudio.url;
                audioTitle.textContent = currentAudio.name;
                audioPlayer.style.display = 'block';
            }
            
            // Set up audio cycling through playlist
            backgroundAudio.addEventListener('ended', () => {
                const currentIndex = audioItems.findIndex(item => item.url === currentAudio.url);
                const nextIndex = (currentIndex + 1) % audioItems.length;
                currentAudio = audioItems[nextIndex];
                backgroundAudio.src = currentAudio.url;
                audioTitle.textContent = currentAudio.name;
                backgroundAudio.play();
            });
        }

        function clearAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            const backgroundAudio = document.getElementById('backgroundAudio');
            
            backgroundAudio.pause();
            backgroundAudio.src = '';
            audioItems = [];
            currentAudio = null;
            audioPlayer.style.display = 'none';
            document.getElementById('audioTitle').textContent = 'No audio selected';
        }

        /* ---------- Media loading (visual only) ---------- */
        function durationMs() { return parseFloat(document.getElementById('speed').value) * 1000; }

        async function addFiles(fileList) {
            const items = Array.from(fileList);
            for (const f of items) {
                if (!validateFile(f)) {
                    systemSounds.error(); // Play error sound
                    const msg = `Invalid file: ${f.name} (type: ${f.type}, size: ${(f.size / (1024 * 1024)).toFixed(1)}MB)`;
                    document.getElementById('status').textContent = msg;
                    setTimeout(() => { if (document.getElementById('status').textContent === msg) document.getElementById('status').textContent = ''; }, 5000);
                    continue;
                }
                const url = URL.createObjectURL(f);
                const type = f.type.startsWith('video') ? 'video' : 'image';
                mediaItems.push({ name: f.name, type, url, duration: durationMs() });
            }
            if (items.length > 0) systemSounds.open(); // Play success sound for added files
            saveLocal(); renderPlaylist();
        }

        /* Demo loader (picsum) */
        async function loadDemo() {
            const urls = [600, 601, 602, 603, 604].map(h => `https://picsum.photos/800/${h}`);
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                mediaItems.push({ name: `demo_${i + 1}.jpg`, type: 'image', url, duration: durationMs() });
            }
            renderPlaylist();
        }

        /* ---------- Documentary flow ---------- */
        function openNext() {
            if (!isRunning) return;
            
            // If we've reached the end, loop back to the beginning
            if (currentIndex >= mediaItems.length) {
                currentIndex = 0; // Reset to beginning
                document.getElementById('status').textContent = 'D√∂ng√º: Ba≈üa d√∂n√ºyor...';
                
                // Brief pause before restarting (optional)
                setTimeout(() => {
                    if (isRunning) { // Check if still running
                        document.getElementById('status').textContent = 'Oynatƒ±lƒ±yor... (d√∂ng√ºde)';
                        openNext(); // Continue with first item
                    }
                }, 1000); // 1 second pause between loops
                return;
            }
            
            const item = mediaItems[currentIndex++];
            createWindow(item, currentIndex - 1);
            const delay = item.type === 'image' ? item.duration : 4000; // video default
            setTimeout(openNext, delay);
        }

        function start() {
            if (!mediaItems.length) { 
                document.getElementById('status').textContent = '√ñnce medya ekleyin.'; 
                return; 
            }
            
            reset();
            
            // seed
            const seedInput = document.getElementById('seed').value;
            rnd = seedInput ? seededRandom(parseInt(seedInput, 10) || 1) : Math.random;
            
            isRunning = true; 
            currentIndex = 0;
            document.getElementById('status').textContent = 'Oynatƒ±lƒ±yor... (d√∂ng√º aktif)';
            openNext();
        }

        function reset() {
            document.querySelectorAll('.window').forEach(w => w.remove());
            openWindows = []; 
            currentIndex = 0; 
            isRunning = false;
            document.getElementById('status').textContent = 'Resetlendi.';
        }

        /* ---------- Recording ---------- */
        async function toggleRecording() {
            const btn = document.getElementById('recBtn');
            const st = document.getElementById('status');
            if (isRecording) {
                mediaRecorder.stop();
                btn.textContent = '‚è∫ Kayƒ±t'; btn.classList.remove('rec');
                isRecording = false; return;
            }
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30 } }, audio: true
                });
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `desktop-documentary-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.webm`;
                    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                    st.textContent = 'Kayƒ±t indirildi (WEBM). MP4 istersen ffmpeg ile d√∂n√º≈üt√ºr.';
                    setTimeout(() => st.textContent = '', 3000);
                };
                mediaRecorder.start();
                btn.textContent = '‚èπ Durdur'; btn.classList.add('rec'); isRecording = true;
                st.textContent = 'Kayƒ±t ba≈üladƒ± (Chrome √∂nerilir).';
            } catch (err) {
                console.error(err); st.textContent = 'Kayƒ±t ba≈ülatƒ±lamadƒ± (izin?).';
                setTimeout(() => st.textContent = '', 3000);
            }
        }

        /* ---------- Wire up ---------- */
        document.getElementById('addBtn').onclick = () => document.getElementById('filePicker').click();
        document.getElementById('filePicker').onchange = (e) => addFiles(e.target.files);
        document.getElementById('audioBtn').onclick = () => document.getElementById('audioPicker').click();
        document.getElementById('audioPicker').onchange = (e) => addAudioFiles(e.target.files);
        document.getElementById('clearAudio').onclick = clearAudio;
        document.getElementById('demoBtn').onclick = loadDemo;
        document.getElementById('textBtn').onclick = toggleTextWindow;
        document.getElementById('startBtn').onclick = () => {
            systemSounds.start(); // Play start sound
            start();
        };
        document.getElementById('resetBtn').onclick = reset;
        document.getElementById('recBtn').onclick = toggleRecording;

        document.getElementById('speed').oninput = (e) => {
            document.getElementById('speedVal').textContent = parseFloat(e.target.value).toFixed(1);
            // yeni eklenen g√∂rsellere bu s√ºre gitsin; mevcutlarƒ± olduƒüu gibi bƒ±rakƒ±yoruz
        };
        document.getElementById('maxWin').oninput = (e) => document.getElementById('maxWinVal').textContent = e.target.value;

        /* drag-drop to desktop */
        const desktop = document.getElementById('desktop');
        desktop.addEventListener('dragover', e => { e.preventDefault(); });
        desktop.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files && e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
        });

        /* ---------- Resizable Panel System ---------- */
        let isResizing = false;
        let currentPanel = null;
        let startX = 0;
        let startWidth = 0;

        function initializeResizablePanels() {
            const controls = document.querySelector('.controls');
            const playlist = document.getElementById('playlist');

            // Panel width resizing
            controls.addEventListener('mousedown', (e) => {
                if (e.offsetX <= 5) { // Left edge resize
                    isResizing = true;
                    currentPanel = 'width';
                    startX = e.clientX;
                    startWidth = parseInt(window.getComputedStyle(controls).width, 10);
                    controls.classList.add('resizing');
                    document.body.style.cursor = 'ew-resize';
                    e.preventDefault();
                }
            });

            // Playlist height resizing (using CSS resize, but we track it)
            const resizeObserver = new ResizeObserver(entries => {
                updatePlaylistInfo();
            });
            resizeObserver.observe(playlist);

            // Global mouse events for resizing
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                if (currentPanel === 'width') {
                    const newWidth = startWidth + (e.clientX - startX);
                    const minWidth = 200;
                    const maxWidth = Math.min(600, window.innerWidth - 40);

                    controls.style.width = Math.max(minWidth, Math.min(maxWidth, newWidth)) + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentPanel = null;
                    controls.classList.remove('resizing');
                    document.body.style.cursor = '';
                    saveResizePreferences();
                }
            });

            // Load saved dimensions
            loadResizePreferences();
        }

        function updatePlaylistInfo() {
            const playlist = document.getElementById('playlist');
            const infoEl = document.querySelector('.playlist-info');

            if (!playlist || !infoEl) return;

            const totalItems = mediaItems.length;
            const visibleHeight = playlist.clientHeight;
            const itemHeight = 32; // Approximate item height
            const visibleItems = Math.floor(visibleHeight / itemHeight);

            if (totalItems > visibleItems) {
                infoEl.textContent = `${visibleItems}/${totalItems} visible - scroll`;
            } else if (totalItems > 0) {
                infoEl.textContent = `${totalItems} items`;
            } else {
                infoEl.textContent = '';
            }
        }

        function saveResizePreferences() {
            const controls = document.querySelector('.controls');
            const playlist = document.getElementById('playlist');

            const prefs = {
                panelWidth: controls.style.width || '240px',
                playlistHeight: playlist.style.height || '120px'
            };

            localStorage.setItem('dd_resize_prefs', JSON.stringify(prefs));
        }

        function loadResizePreferences() {
            const saved = localStorage.getItem('dd_resize_prefs');
            if (!saved) return;

            try {
                const prefs = JSON.parse(saved);
                const controls = document.querySelector('.controls');
                const playlist = document.getElementById('playlist');

                if (prefs.panelWidth) {
                    controls.style.width = prefs.panelWidth;
                }
                if (prefs.playlistHeight) {
                    playlist.style.height = prefs.playlistHeight;
                }
            } catch (e) {
                console.warn('Could not load resize preferences:', e);
            }
        }

        /* ---------- Optional: Add loop indicator ---------- */
        function updateLoopStatus() {
            if (!isRunning) return;
            
            const totalItems = mediaItems.length;
            const currentLoop = Math.floor((currentIndex - 1) / totalItems) + 1;
            const itemInLoop = ((currentIndex - 1) % totalItems) + 1;
            
            if (currentIndex > totalItems) {
                document.getElementById('status').textContent = 
                    `D√∂ng√º ${currentLoop} - √ñƒüe ${itemInLoop}/${totalItems}`;
            }
        }

        /* ---------- Initialize everything ---------- */
        document.addEventListener('DOMContentLoaded', () => {
            initializeResizablePanels();
            initTextFeatures();
            loadLocal();
            renderPlaylist();
        });

        /* ---------- Text Performance Window ---------- */
        let textWindow = null;
        let isTextWindowOpen = false;

        function toggleTextWindow() {
            const btn = document.getElementById('textBtn');
            
            if (isTextWindowOpen) {
                closeTextWindow();
            } else {
                openTextWindow();
            }
        }

        function openTextWindow() {
            if (textWindow) return; // Already open

            const desktop = document.getElementById('desktop');
            textWindow = document.createElement('div');
            textWindow.className = 'text-window';
            textWindow.id = 'textPerformanceWindow';

            // Position in center-left area
            const x = Math.max(50, (window.innerWidth - 400) / 3);
            const y = Math.max(100, (window.innerHeight - 300) / 3);
            
            textWindow.style.left = px(x);
            textWindow.style.top = px(y);
            textWindow.style.zIndex = 200;

            textWindow.innerHTML = `
                <div class="window-titlebar">
                    <div class="window-title">üìù Text Performance - Notepad</div>
                    <div class="window-controls">
                        <div class="window-control" data-act="min">_</div>
                        <div class="window-control" data-act="close">√ó</div>
                    </div>
                </div>
                <div class="text-content">
                    <textarea placeholder="Write here for your performance... You can type live during recording." 
                              id="performanceText" 
                              spellcheck="false"></textarea>
                </div>
            `;

            desktop.appendChild(textWindow);

            // Make draggable
            const titlebar = textWindow.querySelector('.window-titlebar');
            makeDraggable(textWindow, titlebar);

            // Window controls
            textWindow.querySelector('.window-controls').addEventListener('click', (e) => {
                const act = e.target.getAttribute('data-act');
                if (act === 'close') {
                    closeTextWindow();
                }
                if (act === 'min') {
                    textWindow.style.opacity = textWindow.style.opacity === '0.3' ? '1' : '0.3';
                }
            });

            // Focus on textarea
            setTimeout(() => {
                const textarea = textWindow.querySelector('textarea');
                textarea.focus();
            }, 100);

            isTextWindowOpen = true;
            const btn = document.getElementById('textBtn');
            btn.classList.add('active');
            btn.textContent = 'üìù Kapat';

            document.getElementById('status').textContent = 'Metin performans penceresi a√ßƒ±ldƒ±.';
        }

        function closeTextWindow() {
            if (textWindow) {
                textWindow.style.transform = 'scale(0.8)';
                textWindow.style.opacity = '0';
                
                setTimeout(() => {
                    if (textWindow) {
                        textWindow.remove();
                        textWindow = null;
                    }
                }, 200);
            }

            isTextWindowOpen = false;
            const btn = document.getElementById('textBtn');
            btn.classList.remove('active');
            btn.textContent = 'üìù Text';

            document.getElementById('status').textContent = 'Metin performans penceresi kapatƒ±ldƒ±.';
        }

        /* ---------- Enhanced Text Features ---------- */
        function initTextFeatures() {
            // Keyboard shortcuts for text window
            document.addEventListener('keydown', (e) => {
                // Ctrl+T to toggle text window
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    toggleTextWindow();
                }
                
                // Ctrl+Shift+C to clear text (when text window is focused)
                if (e.ctrlKey && e.shiftKey && e.key === 'C' && isTextWindowOpen) {
                    const textarea = document.getElementById('performanceText');
                    if (textarea && document.activeElement === textarea) {
                        e.preventDefault();
                        if (confirm('Are you sure you want to clear the text?')) {
                            textarea.value = '';
                            textarea.focus();
                        }
                    }
                }
            });
        }

        // Add some performance text templates (optional enhancement)
        function insertTemplate(template) {
            const textarea = document.getElementById('performanceText');
            if (!textarea) return;
            
            const templates = {
                'intro': 'Bu benim desktop documentary performansƒ±m...\n\n',
                'poem': 'Ekranƒ±mda a√ßƒ±lan pencereler,\nBir hikaye anlatƒ±yor...\n\n',
                'thoughts': '≈ûu anda d√º≈ü√ºnd√ºklerim:\n- \n- \n- \n\n'
            };
            
            textarea.value += templates[template] || template;
            textarea.focus();
        }
    </script>
</body>

</html>

